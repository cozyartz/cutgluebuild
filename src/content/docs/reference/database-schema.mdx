---
title: Database Schema Reference
description: Complete documentation of Supabase tables, relationships, and data structures
---

import { Card, CardGrid, Badge, Aside } from '@astrojs/starlight/components';

# Database Schema Reference

CutGlueBuild uses Supabase PostgreSQL with Row Level Security (RLS) enabled on all tables. This document covers the complete database schema, relationships, and key patterns.

## Core Tables Overview

<CardGrid>
  <Card title="User Management" icon="user">
    - `profiles` - User profiles and subscription info
    - `user_credits` - Credit tracking and usage
    - `credit_transactions` - Credit transaction history
  </Card>
  
  <Card title="Project System" icon="document">
    - `user_projects` - User-created designs
    - `project_revisions` - Version history
    - Edge functions for revision management
  </Card>
  
  <Card title="Templates" icon="open-book">
    - `templates` - Template library
    - `template_downloads` - Download tracking
    - Free vs premium tier access
  </Card>
  
  <Card title="Content" icon="pencil">
    - `blog_posts` - CMS content
    - `billing_plans` - Subscription tiers
    - Future: comments, favorites
  </Card>
</CardGrid>

## User Management

### profiles

Core user profile information linked to Supabase Auth.

```sql
CREATE TABLE profiles (
  id uuid PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email text,
  full_name text,
  avatar_url text,
  subscription_tier subscription_tier DEFAULT 'free',
  stripe_customer_id text,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

**Key Fields:**
- `id` - References `auth.users(id)` from Supabase Auth
- `subscription_tier` - Enum: `'free' | 'starter' | 'maker' | 'pro'`
- `stripe_customer_id` - Links to Stripe customer for billing

**RLS Policy:**
- Users can only read/update their own profile
- Public read access for display names only

### user_credits

Tracks monthly and rollover credits for each user.

```sql
CREATE TABLE user_credits (
  user_id uuid PRIMARY KEY REFERENCES profiles(id) ON DELETE CASCADE,
  monthly_credits integer DEFAULT 0,
  rollover_credits integer DEFAULT 0,
  used_credits integer DEFAULT 0,
  updated_at timestamptz DEFAULT now()
);
```

**Credit Logic:**
1. Monthly credits reset on billing cycle
2. Unused credits roll over (up to tier limit)
3. Used credits consume monthly first, then rollover

### credit_transactions

Audit log for all credit changes.

```sql
CREATE TABLE credit_transactions (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES profiles(id) ON DELETE CASCADE,
  amount integer NOT NULL,
  source text NOT NULL, -- 'monthly_reset', 'topup', 'admin', 'ai_usage'
  description text,
  created_at timestamptz DEFAULT now()
);
```

## Project System

### user_projects

Main table for user-created designs and projects.

```sql
CREATE TABLE user_projects (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES profiles(id) ON DELETE CASCADE,
  title text NOT NULL,
  description text,
  svg_data text,
  project_type text CHECK (project_type IN ('svg_generated', 'upload_vectorized', 'project_idea')),
  metadata jsonb DEFAULT '{}',
  current_revision_id uuid,
  canvas_settings jsonb DEFAULT '{}',
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

**Key Features:**
- `current_revision_id` - Points to latest saved revision
- `project_type` - Tracks how project was created
- `metadata` - Flexible JSON for project-specific data
- `canvas_settings` - Fabric.js canvas configuration

### project_revisions

Version history system with automatic incremental numbering.

```sql
CREATE TABLE project_revisions (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id uuid REFERENCES user_projects(id) ON DELETE CASCADE,
  revision_number integer NOT NULL,
  svg_data text NOT NULL,
  changes_description text,
  metadata jsonb DEFAULT '{}',
  created_at timestamptz DEFAULT now(),
  UNIQUE(project_id, revision_number)
);
```

**Managed by Edge Functions:**
- `save-project-revision/` - Creates new revision, updates project
- `restore-project-revision/` - Rollback to previous version

<Aside type="note">
  **Edge Function Pattern**: Complex operations that require atomic transactions use Supabase Edge Functions instead of client-side logic.
</Aside>

## Templates System

### templates

Template library with premium/free tiers and metadata.

```sql
CREATE TABLE templates (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  title text NOT NULL,
  description text,
  category text,
  tags text[] DEFAULT '{}',
  materials text[] DEFAULT '{}',
  difficulty text CHECK (difficulty IN ('beginner', 'intermediate', 'advanced')),
  svg_data text,
  preview_url text,
  is_premium boolean DEFAULT false,
  download_count integer DEFAULT 0,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

**Categories:**
- Home & Garden
- Tools & Organization  
- Home Decor
- Kitchen & Dining
- Furniture & Storage
- Outdoor Furniture
- Workshop Furniture

**Access Control:**
- Free templates: Available to all users
- Premium templates: Require `maker` or `pro` subscription tier

### template_downloads

Download tracking with unique constraint per user/template.

```sql
CREATE TABLE template_downloads (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES profiles(id) ON DELETE CASCADE,
  template_id uuid REFERENCES templates(id) ON DELETE CASCADE,
  downloaded_at timestamptz DEFAULT now(),
  UNIQUE(user_id, template_id)
);
```

**Usage:**
- Prevents duplicate download counting
- Enables user download history
- Analytics for popular templates

## Subscription System

### billing_plans

Available subscription plans and their features.

```sql
CREATE TABLE billing_plans (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text NOT NULL,
  tier subscription_tier NOT NULL,
  price_monthly numeric NOT NULL,
  price_yearly numeric NOT NULL,
  monthly_credits integer NOT NULL,
  perks jsonb DEFAULT '{}',
  created_at timestamptz DEFAULT now()
);
```

**Current Tiers:**

| Tier | Monthly Price | Credits | Features |
|------|---------------|---------|----------|
| Free | $0 | 5 | Basic templates, community support |
| Maker | $19 | 100 | Premium templates, priority support |
| Pro | $49 | Unlimited | API access, white-label options |

## Row Level Security (RLS)

All tables use RLS for security. Key patterns:

### User-Scoped Access
```sql
-- Users can only access their own data
CREATE POLICY "Users can view own projects" ON user_projects
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can modify own projects" ON user_projects
  FOR ALL USING (auth.uid() = user_id);
```

### Public Read Access
```sql
-- Templates are publicly readable
CREATE POLICY "Templates are publicly readable" ON templates
  FOR SELECT TO public USING (true);

-- Only admins can modify templates  
CREATE POLICY "Only admins can modify templates" ON templates
  FOR ALL TO authenticated USING (auth.jwt() ->> 'role' = 'admin');
```

### Subscription-Based Access
Template downloads check subscription tier in application logic:

```typescript
// In TemplateDownloadButton component
if (template.is_premium) {
  const user = await authService.getCurrentUser();
  if (user.profile?.subscription_tier === 'free') {
    // Redirect to pricing page
    return;
  }
}
```

## Indexes for Performance

Key indexes for common queries:

```sql
-- Templates
CREATE INDEX idx_templates_category ON templates(category);
CREATE INDEX idx_templates_difficulty ON templates(difficulty);
CREATE INDEX idx_templates_is_premium ON templates(is_premium);
CREATE INDEX idx_templates_tags ON templates USING GIN(tags);
CREATE INDEX idx_templates_created_at ON templates(created_at);

-- Projects
CREATE INDEX idx_user_projects_user_id ON user_projects(user_id);
CREATE INDEX idx_user_projects_created_at ON user_projects(created_at);

-- Revisions
CREATE INDEX idx_project_revisions_project_id ON project_revisions(project_id);
CREATE INDEX idx_project_revisions_created_at ON project_revisions(created_at);
```

## Common Query Patterns

### Fetch User's Projects with Latest Revision
```sql
SELECT 
  p.*,
  pr.svg_data as current_svg,
  pr.revision_number as current_revision
FROM user_projects p
LEFT JOIN project_revisions pr ON p.current_revision_id = pr.id
WHERE p.user_id = $1
ORDER BY p.updated_at DESC;
```

### Get Templates by Category with Download Count
```sql
SELECT *
FROM templates
WHERE category = $1 
  AND (is_premium = false OR $2 != 'free')  -- Check user tier
ORDER BY download_count DESC, created_at DESC;
```

### Credit Balance Check
```sql
SELECT 
  monthly_credits - used_credits as available_monthly,
  rollover_credits
FROM user_credits 
WHERE user_id = $1;
```

## Migration Strategy

Migrations are stored in `supabase/migrations/` with timestamp prefixes:

```
supabase/migrations/
├── 20250613190635_pink_river.sql          # Initial billing system
├── 20250628000000_create_templates_table.sql  # Templates system
└── 20250628000001_populate_templates.sql      # Sample data
```

**Best Practices:**
- Always use transactions for multi-table changes
- Include both schema and data migrations when needed
- Test migrations on staging before production
- Include rollback instructions in comments

---

*This schema evolves as new features are added. Always check the latest migration files for the most current structure.*