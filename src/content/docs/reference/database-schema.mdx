---
title: Database Schema Reference
description: Complete documentation of Cloudflare D1 tables, relationships, and data structures
---

import { Card, CardGrid, Badge, Aside } from '@astrojs/starlight/components';

# Database Schema Reference

CutGlueBuild uses Cloudflare D1 (SQLite) with session-based authentication and server-side authorization. This document covers the complete database schema, relationships, and key patterns.

## Core Tables Overview

<CardGrid>
  <Card title="User Management" icon="user">
    - `profiles` - User profiles and subscription info
    - `user_sessions` - Session-based authentication
  </Card>
  
  <Card title="Project System" icon="document">
    - `user_projects` - User-created designs
    - `project_revisions` - Version history
    - API endpoints for revision management
  </Card>
  
  <Card title="Templates" icon="open-book">
    - `templates` - Template library
    - Download tracking via API calls
    - Free vs premium tier access
  </Card>
  
  <Card title="Content" icon="pencil">
    - `blog_posts` - CMS content
    - Future: comments, favorites
  </Card>
</CardGrid>

## User Management

### profiles

Core user profile information with subscription tiers.

```sql
CREATE TABLE IF NOT EXISTS profiles (
  id TEXT PRIMARY KEY,
  email TEXT UNIQUE NOT NULL,
  full_name TEXT,
  avatar_url TEXT,
  subscription_tier TEXT CHECK (subscription_tier IN ('free', 'starter', 'maker', 'pro')) DEFAULT 'free',
  stripe_customer_id TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**Key Fields:**
- `id` - UUID for user identification
- `subscription_tier` - Enum: `'free' | 'starter' | 'maker' | 'pro'`
- `stripe_customer_id` - Links to Stripe customer for billing

**Authorization:**
- Users can only read/update their own profile via API endpoints
- Server-side session validation enforces access control

### user_sessions

Session-based authentication storage.

```sql
CREATE TABLE IF NOT EXISTS user_sessions (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  expires_at INTEGER NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES profiles (id) ON DELETE CASCADE
);
```

**Session Logic:**
1. Sessions created on login with 30-day expiration
2. Stored as httpOnly cookies (`cutglue_session`)
3. Server-side validation on each request
4. Automatic cleanup of expired sessions

## Project System

### user_projects

Main table for user-created designs and projects.

```sql
CREATE TABLE IF NOT EXISTS user_projects (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  title TEXT NOT NULL,
  description TEXT,
  svg_data TEXT,
  project_type TEXT CHECK (project_type IN ('svg_generated', 'upload_vectorized', 'project_idea')) NOT NULL,
  metadata TEXT, -- JSON as text
  current_revision_id TEXT,
  canvas_settings TEXT, -- JSON as text
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES profiles (id) ON DELETE CASCADE
);
```

**Key Features:**
- `current_revision_id` - Points to latest saved revision
- `project_type` - Tracks how project was created
- `metadata` - Flexible JSON for project-specific data (stored as TEXT)
- `canvas_settings` - Fabric.js canvas configuration (stored as TEXT)

### project_revisions

Version history system with automatic incremental numbering.

```sql
CREATE TABLE IF NOT EXISTS project_revisions (
  id TEXT PRIMARY KEY,
  project_id TEXT NOT NULL,
  revision_number INTEGER NOT NULL,
  svg_data TEXT NOT NULL,
  changes_description TEXT,
  metadata TEXT, -- JSON as text
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (project_id) REFERENCES user_projects (id) ON DELETE CASCADE
);
```

**Managed by API Endpoints:**
- `/api/projects/[projectId]/revisions` - Get revision history
- `/api/projects/[projectId]/restore-revision` - Rollback to previous version

<Aside type="note">
  **API Pattern**: Complex operations that require atomic transactions use Cloudflare Workers API endpoints with D1 database access.
</Aside>

## Templates System

### templates

Template library with premium/free tiers and metadata.

```sql
CREATE TABLE IF NOT EXISTS templates (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  description TEXT,
  category TEXT NOT NULL,
  tags TEXT, -- JSON array as text
  materials TEXT, -- JSON array as text
  difficulty TEXT CHECK (difficulty IN ('beginner', 'intermediate', 'advanced')) DEFAULT 'beginner',
  svg_data TEXT NOT NULL,
  preview_url TEXT,
  is_premium BOOLEAN DEFAULT 0,
  download_count INTEGER DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

**Categories:**
- bird-houses
- home-decor  
- kitchen-items
- organizational-tools
- garden-projects

**Access Control:**
- Free templates: Available to all users
- Premium templates: Require `maker` or `pro` subscription tier
- Download tracking via `/api/templates/track-download` endpoint

## Blog System

### blog_posts

CMS content for blog and documentation.

```sql
CREATE TABLE IF NOT EXISTS blog_posts (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  excerpt TEXT,
  content TEXT NOT NULL,
  author TEXT NOT NULL,
  tags TEXT, -- JSON array as text
  published BOOLEAN DEFAULT 0,
  featured_image TEXT,
  reading_time INTEGER DEFAULT 0,
  published_at DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## Authorization Model

All database access is controlled through API endpoints with session-based authentication:

### User-Scoped Access
```typescript
// Example API endpoint pattern
export async function GET(context) {
  const sessionId = getSessionFromRequest(context.request);
  const user = await authService.getCurrentUser(sessionId);
  
  if (!user) {
    return new Response('Unauthorized', { status: 401 });
  }
  
  // Only return user's own projects
  const projects = await database.getUserProjects(user.id);
  return Response.json(projects);
}
```

### Public Read Access
```typescript
// Templates are publicly readable
export async function GET(context) {
  const templates = await database.getTemplates();
  return Response.json(templates);
}
```

### Subscription-Based Access
Template downloads check subscription tier in API logic:

```typescript
// In /api/templates/track-download endpoint
if (template.is_premium) {
  const user = await getCurrentUser(sessionId);
  if (user.profile?.subscription_tier === 'free') {
    return new Response('Premium subscription required', { status: 403 });
  }
}
```

## Indexes for Performance

Key indexes for common queries:

```sql
-- Templates
CREATE INDEX IF NOT EXISTS idx_templates_category ON templates(category);
CREATE INDEX IF NOT EXISTS idx_templates_is_premium ON templates(is_premium);

-- Projects
CREATE INDEX IF NOT EXISTS idx_user_projects_user_id ON user_projects(user_id);

-- Revisions
CREATE INDEX IF NOT EXISTS idx_project_revisions_project_id ON project_revisions(project_id);

-- Blog
CREATE INDEX IF NOT EXISTS idx_blog_posts_published ON blog_posts(published);
CREATE INDEX IF NOT EXISTS idx_blog_posts_slug ON blog_posts(slug);

-- Sessions
CREATE INDEX IF NOT EXISTS idx_user_sessions_user_id ON user_sessions(user_id);
CREATE INDEX IF NOT EXISTS idx_user_sessions_expires_at ON user_sessions(expires_at);
```

## Common Query Patterns

### Fetch User's Projects
```typescript
const projects = await database.getUserProjects(userId);
// Returns projects with parsed JSON metadata and canvas_settings
```

### Get Templates by Category
```typescript
const templates = await database.getTemplates(category, isPremium);
// Filters by category and premium status
```

### Session Management
```typescript
// Create session
const session = await database.createSession({
  id: generateSessionId(),
  user_id: userId,
  expires_at: Date.now() / 1000 + (30 * 24 * 60 * 60) // 30 days
});

// Validate session
const user = await authService.getCurrentUser(sessionId);
```

## Migration Strategy

Migrations are stored in `migrations/` with numbered prefixes:

```
migrations/
├── 0001_initial_schema.sql     # Complete D1 schema
└── 0002_populate_templates.sql # Sample template data
```

**D1 Deployment Commands:**
```bash
# Create database
wrangler d1 create cutgluebuild-db

# Run migrations
wrangler d1 execute cutgluebuild-db --file migrations/0001_initial_schema.sql
wrangler d1 execute cutgluebuild-db --file migrations/0002_populate_templates.sql

# Production deployment
wrangler d1 migrations apply cutgluebuild-db
```

**Best Practices:**
- Always use transactions for multi-table changes
- Test migrations locally with `wrangler d1 execute`
- Deploy to staging database first
- JSON fields stored as TEXT and parsed in application layer

## API Endpoints

Database operations are handled through Cloudflare Workers API:

- `/api/auth/signin` - User authentication
- `/api/auth/signup` - User registration
- `/api/templates/[id]` - Get template data
- `/api/templates/track-download` - Download tracking
- `/api/projects/[projectId]/revisions` - Project revision history
- `/api/projects/[projectId]/restore-revision` - Project rollback

<Aside type="tip">
  **Performance**: D1 databases are distributed globally on Cloudflare's edge network, providing sub-100ms response times worldwide.
</Aside>

---

*This schema evolves as new features are added. Always check the latest migration files for the most current structure.*